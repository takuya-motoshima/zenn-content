---
title: "PDFãƒ¡ãƒ¼ãƒ«é€ä¿¡ã§3æ™‚é–“ãƒãƒã£ãŸè©±ï¼ˆPuppeteer + AWS SESï¼‰"
emoji: "ğŸ“§"
type: "tech"
topics: ["nodejs", "puppeteer", "awsses", "pdf", "nodemailer"]
published: true
---

## ã¯ã˜ã‚ã«

ã€ŒPDFã‚’ç”Ÿæˆã—ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹ã ã‘ã€ãã†æ€ã£ã¦å®Ÿè£…ã‚’å§‹ã‚ãŸã‚‰ã€æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒå£Šã‚Œã¦é–‹ã‘ãªã„...ãã‚“ãªçµŒé¨“ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

æœ€è¿‘ã€ç›¸ç¶šè¨ºæ–­AIã®Webã‚¢ãƒ—ãƒªã§ã€Œè¨ºæ–­çµæœã®PDFã‚’ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹ã€æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ä¸€è¦‹ã‚·ãƒ³ãƒ—ãƒ«ãªå‡¦ç†ã®ã¯ãšãŒã€å®Ÿè£…ä¸­ã«äºˆæƒ³å¤–ã®è½ã¨ã—ç©´ã«ãƒãƒã‚Šã€æ•°æ™‚é–“ã‚‚æ‚©ã‚€ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€åŒã˜å•é¡Œã§æ‚©ã‚€æ–¹ã®ãŸã‚ã«ã€å®Ÿéš›ã«å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¨å…±ã«ã€ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆã‚’å¾¹åº•è§£èª¬ã—ã¾ã™ã€‚

### ã“ã®è¨˜äº‹ã§è§£èª¬ã™ã‚‹ã“ã¨

- Puppeteerã§HTMLã‹ã‚‰PDFã‚’ç”Ÿæˆ
- ç”Ÿæˆã—ãŸPDFã‚’AWS SESã§ãƒ¡ãƒ¼ãƒ«æ·»ä»˜é€ä¿¡
- nodemailerã‚’ä½¿ã£ãŸã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…æ–¹æ³•

### çµè«–: 2ã¤ã®ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ

å…ˆã«çµè«–ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚PDFæ·»ä»˜ãƒ¡ãƒ¼ãƒ«ã§å¤±æ•—ã™ã‚‹åŸå› ã¯ã€ä¸»ã«ã“ã®2ç‚¹ã§ã™ï¼š

1. **Puppeteerã®`page.pdf()`ã¯`Uint8Array`ã‚’è¿”ã™** â†’ `Buffer.from()`ã§å¤‰æ›ãŒå¿…é ˆ
2. **nodemailerã«ã¯`@aws-sdk/client-sesv2`ãŒå¿…è¦** â†’ ãƒ¬ã‚¬ã‚·ãƒ¼ãª`client-ses`ã§ã¯å‹•ä½œã—ãªã„

ã“ã®2ç‚¹ã‚’æŠ¼ã•ãˆã‚Œã°ã€ç¢ºå®Ÿã«å‹•ä½œã—ã¾ã™ã€‚ã•ã‚‰ã«ã€nodemailerã‚’ä½¿ã†ã“ã¨ã§ã€MIMEæ§‹ç¯‰ã‚„Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ã§å‡¦ç†ã—ã¦ãã‚Œã‚‹ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ãŒå¤§å¹…ã«ç°¡æ½”ã«ãªã‚Šã¾ã™ã€‚

## ç’°å¢ƒæ§‹ç¯‰

### å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

```bash
npm install puppeteer nodemailer @aws-sdk/client-sesv2
```

## å®Ÿè£…ã‚³ãƒ¼ãƒ‰

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ `index.js` ã¨ã—ã¦ä¿å­˜ã™ã‚Œã°ã€ã™ãã«å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚

```javascript
import puppeteer from 'puppeteer';
import nodemailer from 'nodemailer';
import {SESv2Client, SendEmailCommand} from '@aws-sdk/client-sesv2';

// AWS SESèªè¨¼æƒ…å ±ï¼ˆAWS IAMã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å–å¾—ã€å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
const AWS_SES_REGION = 'ap-northeast-1';  // æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
const AWS_SES_ACCESS_KEY_ID = 'AKIA******************';
const AWS_SES_SECRET_ACCESS_KEY = '****************************************';

// ãƒ¡ãƒ¼ãƒ«é€ä¿¡è¨­å®šï¼ˆå®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
const FROM_EMAIL = 'sender@example.com';    // é€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆSESã§æ¤œè¨¼æ¸ˆã¿ï¼‰
const TO_EMAIL = 'recipient@example.com';   // é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

/**
 * HTMLã‹ã‚‰PDFã‚’ç”Ÿæˆ
 *
 * ãƒã‚¤ãƒ³ãƒˆ: page.pdf()ã¯ Uint8Array ã‚’è¿”ã™ãŸã‚ã€Buffer.from()ã§å¤‰æ›ãŒå¿…é ˆ
 */
async function generatePdf() {
  let browser;

  try {
    const html = `
      <!DOCTYPE html>
      <html lang="ja">
      <head>
        <meta charset="UTF-8">
        <title>ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒãƒ¼ãƒˆ</title>
        <style>
          body { font-family: sans-serif; padding: 20px; }
          h1 { color: #333; }
        </style>
      </head>
      <body>
        <h1>ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒãƒ¼ãƒˆ</h1>
        <p>ã“ã‚Œã¯Puppeteerã§ç”Ÿæˆã—ãŸPDFã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚</p>
      </body>
      </html>
    `;

    browser = await puppeteer.launch({
      headless: true,
      args: [
        '--no-sandbox',                    // ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç„¡åŠ¹åŒ–ï¼ˆDocker/CIç’°å¢ƒã§å¿…é ˆï¼‰
        '--disable-setuid-sandbox',        // setuidã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç„¡åŠ¹åŒ–ï¼ˆæ¨©é™é–¢é€£ã®å•é¡Œå›é¿ï¼‰
        '--disable-dev-shm-usage',         // /dev/shmã®ä½¿ç”¨ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ¡ãƒ¢ãƒªä¸è¶³å¯¾ç­–ï¼‰
        '--disable-gpu',                   // GPUç„¡åŠ¹åŒ–ï¼ˆã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã¯ä¸è¦ï¼‰
        '--no-first-run',                  // åˆå›èµ·å‹•æ™‚ã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé«˜é€ŸåŒ–ï¼‰
        '--no-zygote',                     // Zygoteãƒ—ãƒ­ã‚»ã‚¹ç„¡åŠ¹åŒ–ï¼ˆãƒ¡ãƒ¢ãƒªå‰Šæ¸›ï¼‰
        '--single-process',                // ã‚·ãƒ³ã‚°ãƒ«ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ¡ãƒ¢ãƒªå‰Šæ¸›ã€å®‰å®šæ€§å‘ä¸Šï¼‰
        '--disable-web-security',          // åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒãƒªã‚·ãƒ¼ç„¡åŠ¹åŒ–ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«HTMLã®èª­ã¿è¾¼ã¿è¨±å¯ï¼‰
        '--disable-features=VizDisplayCompositor'  // æç”»æœ€é©åŒ–ã‚’ç„¡åŠ¹åŒ–ï¼ˆå®‰å®šæ€§å„ªå…ˆï¼‰
      ]
    });

    const page = await browser.newPage();
    await page.setContent(html, { waitUntil: 'domcontentloaded' });

    const pdfBuffer = await page.pdf({
      format: 'A4',                      // ç”¨ç´™ã‚µã‚¤ã‚ºï¼ˆA4, Letter, Legalç­‰ï¼‰
      printBackground: true,              // èƒŒæ™¯è‰²ãƒ»èƒŒæ™¯ç”»åƒã‚’å°åˆ·
      margin: {                           // ä½™ç™½è¨­å®š
        top: '10mm',
        right: '10mm',
        bottom: '10mm',
        left: '10mm'
      },
      preferCSSPageSize: false,           // CSS @page ã‚µã‚¤ã‚ºã‚’å„ªå…ˆã—ãªã„
      displayHeaderFooter: false          // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã‚’éè¡¨ç¤º
    });

    // ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆâ‘ : Uint8Array â†’ Bufferå¤‰æ›
    // NG: return pdfBuffer;  // Uint8Arrayã®ã¾ã¾
    // OK: Buffer.from()ã§å¤‰æ›ã—ã¦ã‹ã‚‰è¿”ã™ï¼ˆnodemailerãŒç¢ºå®Ÿã«å‡¦ç†ã§ãã‚‹ï¼‰
    return Buffer.from(pdfBuffer);
  } finally {
    if (browser) await browser.close();
  }
}

/**
 * AWS SESã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆPDFæ·»ä»˜ï¼‰
 *
 * ãƒã‚¤ãƒ³ãƒˆ: nodemailerã‚’ä½¿ãˆã°MIMEæ§‹ç¯‰ã¨Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•åŒ–ã•ã‚Œã‚‹
 */
async function sendEmail({ from, to, subject, html, attachments }) {
  // AWS SESv2ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
  const sesClient = new SESv2Client({
    region: AWS_SES_REGION,
    credentials: {
      accessKeyId: AWS_SES_ACCESS_KEY_ID,
      secretAccessKey: AWS_SES_SECRET_ACCESS_KEY,
    }
  });

  // nodemailer transporterä½œæˆ
  const transporter = nodemailer.createTransport({
    SES: {
      sesClient,
      SendEmailCommand
    }
  });

  // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•ã§Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã‚‹ï¼‰
  await transporter.sendMail({
    from,
    to,
    subject,
    html,
    attachments: attachments || []
  });

  console.log('ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
}

/**
 * ãƒ¡ã‚¤ãƒ³å‡¦ç†
 */
async function main() {
  try {
    console.log('PDFç”Ÿæˆä¸­...');
    const pdfBuffer = await generatePdf();
    console.log(`PDFç”Ÿæˆå®Œäº† - ã‚µã‚¤ã‚º: ${pdfBuffer.length} bytes`);

    console.log('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...');
    await sendEmail({
      from: FROM_EMAIL,
      to: TO_EMAIL,
      subject: 'ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä»˜ã—ã¾ã™',
      html: '<p>ãƒ¬ãƒãƒ¼ãƒˆã‚’æ·»ä»˜ã—ã¾ã—ãŸã€‚</p>',
      attachments: [
        { filename: 'report.pdf', content: pdfBuffer }
      ]
    });

    console.log('å®Œäº†');
  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼:', error);
  }
}

main();
```

### å®Ÿè¡Œæ–¹æ³•

ã‚³ãƒ¼ãƒ‰å†…ã®å®šæ•°ï¼ˆ`AWS_SES_ACCESS_KEY_ID`ã€`AWS_SES_SECRET_ACCESS_KEY`ã€`FROM_EMAIL`ã€`TO_EMAIL`ï¼‰ã‚’å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã™ï¼š

```bash
node index.js
```

## ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆã‚’è©³ã—ãè§£èª¬

ã“ã“ã‹ã‚‰ãŒæœ¬é¡Œã§ã™ã€‚å®Ÿè£…ä¸­ã«æ‚©ã‚“ã 2ã¤ã®å•é¡Œã‚’ã€è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

### ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆâ‘ : Uint8Array vs Buffer

**ã“ã‚ŒãŒæœ€å¤§ã®è½ã¨ã—ç©´ã§ã—ãŸã€‚**

Puppeteerã®`page.pdf()`ã¯ã€å®Ÿã¯`Uint8Array`ã‚’è¿”ã—ã¾ã™ã€‚ã—ã‹ã—ã€nodemailerã«`Uint8Array`ã‚’ãã®ã¾ã¾æ¸¡ã™ã¨ã€PDFãŒå£Šã‚Œã¦é–‹ã‘ãªããªã‚Šã¾ã™ã€‚

```javascript
// NG: Uint8Arrayã®ã¾ã¾ã§ã¯nodemailerã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§
const pdfBuffer = await page.pdf({ ... });
// pdfBufferã¯Uint8Array

// OK: Buffer.from()ã§å¤‰æ›ã—ã¦ã‹ã‚‰ä½¿ã†
const pdfBuffer = await page.pdf({ ... });
return Buffer.from(pdfBuffer);  // ã“ã‚Œã§ç¢ºå®Ÿã«Bufferã¨ã—ã¦æ‰±ãˆã‚‹
```

**ãªãœå¤‰æ›ãŒå¿…è¦ï¼Ÿ**
nodemailerã¯å†…éƒ¨ã§Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’è¡Œã„ã¾ã™ãŒã€`Uint8Array`ã‚’ç›´æ¥æ‰±ã†ã¨æ­£ã—ãã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚`Buffer.from()`ã§ç¢ºå®Ÿã«`Buffer`å‹ã«å¤‰æ›ã™ã‚‹ã“ã¨ã§ã€ã“ã®å•é¡Œã‚’å›é¿ã§ãã¾ã™ã€‚

### ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆâ‘¡: @aws-sdk/client-sesv2ãŒå¿…è¦

**ã‚‚ã†ä¸€ã¤ã®è½ã¨ã—ç©´ãŒã“ã‚Œã§ã™ã€‚**

nodemailerã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã¨ã€ä¸€è¦‹`@aws-sdk/client-ses`ã‚’ä½¿ãˆã°è‰¯ã•ãã†ã«è¦‹ãˆã¾ã™ã€‚ã—ã‹ã—ã€å®Ÿéš›ã«ã¯æœ€æ–°ç‰ˆã®nodemailerã¯`@aws-sdk/client-sesv2`ï¼ˆSES API v2ï¼‰ã‚’è¦æ±‚ã—ã¾ã™ã€‚

```javascript
// NG: ãƒ¬ã‚¬ã‚·ãƒ¼ãªclient-sesã‚’ä½¿ã†ã¨ã‚¨ãƒ©ãƒ¼
import {SESClient} from '@aws-sdk/client-ses';  // å‹•ä½œã—ãªã„

// OK: client-sesv2ã‚’ä½¿ã†
import {SESv2Client, SendEmailCommand} from '@aws-sdk/client-sesv2';  // æ­£ã—ã„
```

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**:
ãƒ¬ã‚¬ã‚·ãƒ¼ãª`client-ses`ã‚’ä½¿ã†ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š
```
Using legacy SES configuration, expecting @aws-sdk/client-sesv2
```

ã“ã‚ŒãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…¥ã‚Œæ›¿ãˆã¾ã—ã‚‡ã†ï¼š
```bash
npm uninstall @aws-sdk/client-ses
npm install @aws-sdk/client-sesv2
```

## å®Ÿå‹™ã§å½¹ç«‹ã¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š

ã“ã“ã‹ã‚‰ã¯ã€å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ãˆã‚‹è©³ç´°è¨­å®šã‚’è§£èª¬ã—ã¾ã™ã€‚

### PDFç”Ÿæˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆpage.pdfï¼‰

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | å€¤ | èª¬æ˜ |
|----------|------|------|
| `format` | `'A4'` | ç”¨ç´™ã‚µã‚¤ã‚ºï¼ˆA4, A3, Letter, Legal, Tabloidç­‰ï¼‰ |
| `printBackground` | `true` | èƒŒæ™¯è‰²ãƒ»èƒŒæ™¯ç”»åƒã‚’å°åˆ·ã«å«ã‚ã‚‹ |
| `margin.top` | `'10mm'` | ä¸Šä½™ç™½ï¼ˆmm, cm, in, pxæŒ‡å®šå¯ï¼‰ |
| `margin.right` | `'10mm'` | å³ä½™ç™½ |
| `margin.bottom` | `'10mm'` | ä¸‹ä½™ç™½ |
| `margin.left` | `'10mm'` | å·¦ä½™ç™½ |
| `preferCSSPageSize` | `false` | CSS @page ã‚µã‚¤ã‚ºã‚’å„ªå…ˆã—ãªã„ï¼ˆformatå„ªå…ˆï¼‰ |
| `displayHeaderFooter` | `false` | ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã‚’éè¡¨ç¤º |

**ãã®ä»–ã®ä¾¿åˆ©ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³**:
```javascript
{
  format: 'A4',
  printBackground: true,
  margin: { top: '10mm', right: '10mm', bottom: '10mm', left: '10mm' },
  preferCSSPageSize: false,
  displayHeaderFooter: true,           // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼è¡¨ç¤º
  headerTemplate: '<div style="font-size:10px; text-align:center; width:100%;">ãƒ˜ãƒƒãƒ€ãƒ¼</div>',
  footerTemplate: '<div style="font-size:10px; text-align:center; width:100%;"><span class="pageNumber"></span> / <span class="totalPages"></span></div>',
  landscape: false,                    // false=ç¸¦å‘ã, true=æ¨ªå‘ã
  scale: 1                             // æ‹¡å¤§ç¸®å°ï¼ˆ0.1ã€œ2.0ï¼‰
}
```

### Puppeteerèµ·å‹•ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆlaunchï¼‰

æœ¬ç•ªç’°å¢ƒï¼ˆDockerã€EC2ã€Lambdaç­‰ï¼‰ã§å¿…è¦ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³:

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ | å¿…è¦æ€§ |
|----------|------|-------|
| `--no-sandbox` | Chromeã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚’ç„¡åŠ¹åŒ– | Docker/CIç’°å¢ƒã§ã¯å¿…é ˆï¼ˆæ¨©é™ä¸è¶³ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰ |
| `--disable-setuid-sandbox` | setuidã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚’ç„¡åŠ¹åŒ– | æ¨©é™é–¢é€£ã®å•é¡Œã‚’å›é¿ |
| `--disable-dev-shm-usage` | `/dev/shm`å…±æœ‰ãƒ¡ãƒ¢ãƒªã®ä½¿ç”¨ã‚’ç„¡åŠ¹åŒ– | ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼ˆç‰¹ã«Dockerï¼‰ |
| `--disable-gpu` | GPUå‡¦ç†ã‚’ç„¡åŠ¹åŒ– | ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã¯GPUä¸è¦ã€å®‰å®šæ€§å‘ä¸Š |
| `--no-first-run` | åˆå›èµ·å‹•æ™‚ã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ— | èµ·å‹•æ™‚é–“çŸ­ç¸® |
| `--no-zygote` | Zygoteãƒ—ãƒ­ã‚»ã‚¹ç”Ÿæˆã‚’ç„¡åŠ¹åŒ– | ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å‰Šæ¸› |
| `--single-process` | ã‚·ãƒ³ã‚°ãƒ«ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œ | ãƒ¡ãƒ¢ãƒªå‰Šæ¸›ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ™‚ã®å¾©æ—§ãŒå®¹æ˜“ |
| `--disable-web-security` | åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒãƒªã‚·ãƒ¼ã‚’ç„¡åŠ¹åŒ– | ãƒ­ãƒ¼ã‚«ãƒ«HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’è¨±å¯ |
| `--disable-features=VizDisplayCompositor` | æç”»æœ€é©åŒ–æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ– | æç”»ãƒã‚°å›é¿ã€å®‰å®šæ€§å„ªå…ˆ |

**æ¨å¥¨ç’°å¢ƒ**: ä¸Šè¨˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æœ¬ç•ªç’°å¢ƒï¼ˆEC2ã€Dockerã€Lambdaç­‰ï¼‰ã§æ¨å¥¨ã€‚ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ã¯`headless: true`ã®ã¿ã§ã‚‚å‹•ä½œã—ã¾ã™ã€‚

## ã¾ã¨ã‚

PDFæ·»ä»˜ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã§ãƒãƒã‚‹åŸå› ã¯ã€ä¸»ã«ã“ã®2ç‚¹ã§ã™ï¼š

1. **Puppeteerã®`page.pdf()`ã¯`Uint8Array`ã‚’è¿”ã™** â†’ `Buffer.from()`ã§å¤‰æ›å¿…é ˆ
2. **nodemailerã«ã¯`@aws-sdk/client-sesv2`ãŒå¿…è¦** â†’ ãƒ¬ã‚¬ã‚·ãƒ¼ãª`client-ses`ã§ã¯å‹•ä½œã—ãªã„

ã“ã®2ç‚¹ã•ãˆæŠ¼ã•ãˆã‚Œã°ã€ã‚ã¨ã¯nodemailerãŒè‡ªå‹•ã§MIMEæ§‹ç¯‰ã¨Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å‡¦ç†ã—ã¦ãã‚Œã¾ã™ã€‚æ‰‹å‹•å®Ÿè£…ã«æ¯”ã¹ã¦ã€ã‚³ãƒ¼ãƒ‰ãŒç´„50%å‰Šæ¸›ã•ã‚Œã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚‚å¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚

åŒã˜å•é¡Œã§æ‚©ã‚“ã§ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

## ã‚ˆãã‚ã‚‹ãƒˆãƒ©ãƒ–ãƒ«ã¨è§£æ±ºæ–¹æ³•

å®Ÿè£…ä¸­ã«é­é‡ã—ã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ã¨ã€ãã®è§£æ±ºæ–¹æ³•ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚

### ã‚¨ãƒ©ãƒ¼â‘ : ã€ŒUsing legacy SES configurationã€

**ç—‡çŠ¶**:
```
Using legacy SES configuration, expecting @aws-sdk/client-sesv2
```

**è§£æ±ºæ–¹æ³•**:
ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã ã‘ã§ã™ã€‚
```bash
npm uninstall @aws-sdk/client-ses
npm install @aws-sdk/client-sesv2
```

### ã‚¨ãƒ©ãƒ¼â‘¡: PDFãŒå£Šã‚Œã¦é–‹ã‘ãªã„

**ç—‡çŠ¶**:
ãƒ¡ãƒ¼ãƒ«ã«æ·»ä»˜ã•ã‚ŒãŸPDFã‚’é–‹ã“ã†ã¨ã™ã‚‹ã¨ã€ŒPDFãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€ã‚¨ãƒ©ãƒ¼

**è§£æ±ºæ–¹æ³•**:
`Uint8Array` â†’ `Buffer`å¤‰æ›ã‚’å¿˜ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```javascript
// ã“ã‚Œã‚’å¿˜ã‚Œãšã«
return Buffer.from(pdfBuffer);
```

### ã‚¨ãƒ©ãƒ¼â‘¢: Puppeteerã®ãƒ¡ãƒ¢ãƒªä¸è¶³

**ç—‡çŠ¶**:
```
Error: Protocol error (Page.printToPDF): Target closed
```

**è§£æ±ºæ–¹æ³•**:
Puppeteerã®èµ·å‹•ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’èª¿æ•´ã—ã¾ã™ï¼ˆç‰¹ã«`--disable-dev-shm-usage`ã¨`--single-process`ãŒé‡è¦ï¼‰ã€‚

```javascript
browser = await puppeteer.launch({
  headless: true,
  args: [
    '--no-sandbox',
    '--disable-setuid-sandbox',
    '--disable-dev-shm-usage',  // é‡è¦
    '--disable-gpu',
    '--single-process'  // é‡è¦
  ]
});
```

Dockerç’°å¢ƒã®å ´åˆã¯ã€`--shm-size`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å…±æœ‰ãƒ¡ãƒ¢ãƒªã‚’å¢—ã‚„ã™ã“ã¨ã‚‚æœ‰åŠ¹ã§ã™ï¼š
```bash
docker run --shm-size=2gb your-image
```

## å‚è€ƒè³‡æ–™

- [Nodemailer - SES Transport](https://nodemailer.com/transports/ses/)
- [AWS SDK for JavaScript v3 - SESv2](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/sesv2/)
- [Puppeteer API - page.pdf()](https://pptr.dev/api/puppeteer.page.pdf)