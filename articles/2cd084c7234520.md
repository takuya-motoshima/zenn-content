---
title: "「障害、お客様から聞きました」をなくす。CloudWatch Syntheticsで始めるAPI監視"
emoji: "🐤"
type: "tech"
topics: ["aws", "cloudwatch", "monitoring", "api", "synthetics"]
published: true
---

## お客様より先に気づきたい

「すみません、APIがエラーになってるんですけど...」

お客様からの問い合わせで障害に気づく。エンジニアなら一度は経験があるんじゃないでしょうか。

サーバーの死活監視はしている。CPUもメモリも正常。でもアプリケーションレベルで何かがおかしくて、APIが500を返し続けている。そんな状況、死活監視だけじゃ検知できないんですよね。

この問題を解決するのが **Synthetic Monitoring（合成モニタリング）** です。本物のユーザーを待たずに、定期的にAPIを叩いて動作確認する。お客様より先に異常を検知できる仕組みです。

今回は、AWSの **CloudWatch Synthetics** を使ってAPI監視を設定する手順を紹介します。

## CloudWatch Synthetics（シンセティクス）とは

### 合成モニタリングってなに？

ユーザーと同じ操作を自動で実行して、システムが正常に動くか確認する監視手法です。

ログインできるか、商品が検索できるか、決済が通るか。
実際のユーザーアクセスを待つんじゃなくて、こっちから能動的にチェックしに行く。
5分おきとか、1時間おきとか、設定した間隔で自動的にリクエストを送って、おかしかったらアラートを上げる。

CloudWatch Syntheticsは、AWSが提供するこの合成モニタリングのマネージドサービスです。

### Canary（カナリア）とは

CloudWatch Syntheticsでは、監視タスクのことを **Canary** と呼びます。「このエンドポイントを5分おきにチェックして」みたいな設定をCanaryとして作成します。

### できること

- 指定したURLに定期的にリクエストを送信
- ステータスコードやレスポンス内容をチェック
- 失敗したらCloudWatch Alarmで通知
- リクエスト/レスポンスのログをS3に保存

### 料金

月100回までは無料枠で使えます。それ以上は従量課金。詳しくは[CloudWatch料金ページ](https://aws.amazon.com/jp/cloudwatch/pricing/)を確認してください。

## 事前準備：テスト用APIサーバー

Canaryの動作確認用に、シンプルなAPIサーバーを用意します。すでに監視対象のAPIがある場合はスキップしてください。

### app.js

```javascript
const express = require('express');
const app = express();

const args = process.argv.slice(2);
const portIndex = args.indexOf('--port');
const PORT = portIndex !== -1 ? args[portIndex + 1] : (process.env.PORT || 3000);

app.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

### package.json

```json
{
  "name": "canary-test",
  "version": "1.0.0",
  "main": "app.js",
  "scripts": {
    "start": "node app.js",
    "pm2:start": "pm2 start app.js --name canary-test -- --port 3000"
  },
  "dependencies": {
    "express": "^5.2.1"
  }
}
```

### 起動

```bash
npm install
npm install -g pm2
npm run pm2:start
```

確認:

```bash
curl http://localhost:3000/health
# {"status":"ok","timestamp":"2026-01-06T..."}
```

## Canaryを作成する

### 1. CloudWatchを開く

AWSコンソールからCloudWatchを選択。

![CloudWatchコンソール](/images/2cd084c7234520/1-cloudwatch-top.jpeg)

### 2. API Canaryを選択

左メニューの「Synthetics Canaries」から「Canaryを作成」をクリック。

設計図は「API Canary」を選択して、名前をつけます（今回は `canary-test`）。

![API Canary選択](/images/2cd084c7234520/2-api-canary-select.jpeg)

### 3. エンドポイントを入力

監視したいAPIのURLを入力します。

![エンドポイント入力](/images/2cd084c7234520/3-endpoint-input.jpeg)

### 4. スケジュール設定

実行間隔を設定。今回は5分おきにしました。

![スケジュール設定](/images/2cd084c7234520/4-schedule-setting.jpeg)

### 5. 作成

「Canaryを作成」をクリックして完了。

![Canary作成](/images/2cd084c7234520/5-canary-created.jpeg)

## 結果を確認する

作成が完了すると、設定した間隔で自動的に実行が始まります。

### 成功/失敗

一覧画面で結果が確認できます。緑が成功、赤が失敗。

![実行結果](/images/2cd084c7234520/6-execution-result.jpeg)

### グラフ

一覧から作成したCanary（canary-test）をクリックすると、成功率やレスポンスタイムの推移が見られます。

![詳細グラフ](/images/2cd084c7234520/7-detail-graph.jpeg)

### 実行履歴

各実行の詳細（リクエスト/レスポンス、実行時間）も確認可能。

![実行履歴](/images/2cd084c7234520/8-detail-history.jpeg)

## 今回の設定まとめ

| 項目 | 設定値 |
|------|--------|
| 設計図 | API Canary |
| 名前 | canary-test |
| エンドポイントURL | http://your-server-ip:3000/health |
| HTTPメソッド | GET |
| ヘッダー | Content-Type: application/json |
| 実行間隔 | 5分 |
| データ保持 | 31日 |

## 応用：こんなこともできる

基本的なヘルスチェックはこれで十分ですが、スクリプトを編集すればもっと細かいチェックもできます。ここでは概要だけ紹介します。

- **レスポンス内容の検証** : ステータスコードだけじゃなく、JSONの中身が期待通りかチェック
- **複数ステップの実行** : ログイン→API呼び出し→ログアウトのような一連のフローをテスト
- **レスポンスタイムの監視** : 3秒以上かかったらエラーにする、みたいな閾値設定
- **認証付きAPI** : Bearerトークンなどの認証ヘッダーを付与

詳しい実装方法は[公式のスクリプトサンプル](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries_Blueprints.html)を参照してください。

## まとめ

「すみません、APIがエラーになってるんですけど...」

冒頭のこの一言、もう聞きたくないですよね。

CloudWatch Synthetics Canaryを設定すれば、5分おきに自動でAPIをチェックしてくれます。お客様が気づく前に、自分たちで異常を検知できる。設定もコンソールからポチポチするだけで、30分もあれば動き始めます。

死活監視だけでは守れなかった「アプリケーションレベルの異常」を、これでカバーできます。

次のステップとして、失敗時にSlackやメールへ通知を飛ばすCloudWatch Alarmとの連携を設定すると、より実用的な監視体制が作れます。

## 参考

- [AWS CloudWatch Synthetics ドキュメント](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries.html)
- [Canary スクリプトのサンプル](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries_Blueprints.html)
